"""
Промпты для ИИ обработки кредитных отчётов
"""

# JSON схема для структурирования данных
JSON_SCHEMA = """
{
  "metadata": {
    "processing_id": "uuid",
    "processed_at": "ISO timestamp",
    "source_filename": "string",
    "bki_type": "string",
    "confidence_overall": 0.85
  },
  "subject": {
    "full_name": {
      "value": "string",
      "confidence": 0.95,
      "evidence": [{"page": 1, "bbox": [x1,y1,x2,y2], "text": "string"}]
    },
    "birth_date": {
      "value": "YYYY-MM-DD",
      "confidence": 0.9,
      "evidence": []
    },
    "passport": {
      "series": "string",
      "number": "string",
      "confidence": 0.9,
      "evidence": []
    }
  },
  "accounts": [
    {
      "creditor": {"name": "string", "type": "string"},
      "product_type": "string",
      "account_number": "string",
      "dates": {"open": "YYYY-MM-DD", "close": "YYYY-MM-DD"},
      "amounts": {"limit": 0.0, "current_balance": 0.0},
      "status": {"general": "string", "delinquency_days": 0}
    }
  ],
  "summary": {
    "total_debt": 0.0,
    "active_accounts": 0,
    "max_delinquency_days": 0,
    "credit_score": 0,
    "risk_score": "низкий/средний/высокий"
  }
}
"""


def get_base_extraction_prompt(bki_type: str, pdf_text: str) -> str:
    """Основной промпт для структурирования данных"""
    return f"""Ты — эксперт по анализу кредитных отчётов российских БКИ.

ИНСТРУКЦИИ:
1. Извлеки структурированные данные из текста кредитного отчёта
2. Верни ТОЛЬКО JSON в указанной схеме
3. Для каждого поля укажи confidence (0.0-1.0)
4. Используй evidence для важных полей (страница, координаты, текст)

ТИП БКИ: {bki_type}

JSON СХЕМА:
{JSON_SCHEMA}

ТЕКСТ ОТЧЁТА:
{pdf_text[:4000]}

Важно: 
- Даты в ISO формате (YYYY-MM-DD)
- Суммы в числах (без валюты)
- Статусы стандартизировать (активный, закрыт, просрочен)
- Если данные не найдены, используй null
- confidence_overall - общая уверенность в извлечении (0.0-1.0)

Верни ТОЛЬКО валидный JSON без дополнительных комментариев."""


def get_bki_specific_prompt(bki_type: str) -> str:
    """Возвращает специфичные инструкции для типа БКИ"""
    prompts = {
        'НБКИ': """
        Особенности формата НБКИ:
        1. Раздел "Субъект кредитной истории" - ФИО, дата рождения, паспорт
        2. Таблицы "Кредитные обязательства" - все активные и закрытые счета
        3. Секция "Запросы о предоставлении кредитных отчётов" - история запросов
        4. Обрати внимание на статусы: "Действующий", "Закрыт", "Просрочен"
        """,
        
        'ОКБ': """
        Особенности формата ОКБ:
        1. Блок "Информация о заёмщике" - персональные данные
        2. Таблица "Сведения об обязательствах" - кредиты и займы
        3. Раздел "История запросов" - кто и когда запрашивал отчёт
        4. Статусы могут быть: "Открыт", "Закрыт", "Просрочка"
        """,
        
        'Скоринг Бюро': """
        Особенности формата Скоринг Бюро:
        1. "Данные физического лица" - ФИО, паспорт
        2. "Активные договоры займа" - текущие обязательства
        3. "Скоринговый балл" - кредитный рейтинг
        4. Обрати внимание на микрофинансовые организации
        """,
        
        'Эквифакс': """
        Особенности формата Equifax:
        1. "Consumer Information" - информация о заёмщике
        2. "Trade Lines" - кредитные линии
        3. "Inquiries" - запросы
        4. Формат может быть на английском или русском
        """,
        
        'КБ Киви': """
        Особенности формата КБ Киви:
        1. Блок с персональными данными
        2. Список кредитных обязательств
        3. История запросов
        """,
        
        'Русский Стандарт БКИ': """
        Особенности формата Русский Стандарт БКИ:
        1. Информация о субъекте кредитной истории
        2. Детализация по каждому обязательству
        3. Статусы и даты
        """
    }
    
    return prompts.get(bki_type, prompts['НБКИ'])


def get_error_detection_prompt(json_data: str) -> str:
    """Промпт для детекции ошибок в данных"""
    return f"""Проанализируй кредитные данные на ошибки и несоответствия.

ПРОВЕРЬ:
1. Противоречия в статусах (счёт закрыт, но есть текущий долг)
2. Невозможные даты (дата закрытия раньше даты открытия)
3. Дублирующиеся записи (одинаковые счета)
4. Несоответствие лимитов и остатков (остаток больше лимита)
5. Некорректные суммы (отрицательные там, где не должно быть)

ДАННЫЕ:
{json_data}

Верни ТОЛЬКО JSON в формате:
{{
  "errors": [
    {{
      "type": "string (contradiction/date_error/duplicate/amount_error)",
      "field": "string (путь к полю, например accounts[0].status)",
      "incorrect_value": "string",
      "correct_value": "string или null",
      "evidence": "string (объяснение проблемы)",
      "severity": "low/medium/high"
    }}
  ],
  "requires_bki_letter": boolean,
  "confidence": 0.0-1.0
}}"""


def get_recommendations_prompt(json_data: str) -> str:
    """Промпт для генерации рекомендаций"""
    return f"""На основе кредитных данных сгенерируй аналитические рекомендации.

ДАННЫЕ:
{json_data}

СФОКУСИРУЙСЯ НА:
1. Уровень долговой нагрузки (отношение долга к доходам)
2. Риски просрочек (текущие просрочки, история)
3. Возможности рефинансирования (высокие проценты, несколько кредитов)
4. Улучшение кредитной истории (закрытие просроченных, погашение долгов)

Верни ТОЛЬКО JSON в формате:
{{
  "risk_level": "низкий/средний/высокий/критический",
  "risk_factors": ["фактор1", "фактор2"],
  "recommendations": [
    {{
      "priority": "high/medium/low",
      "action": "string (что делать)",
      "reason": "string (почему это важно)",
      "expected_impact": "string (какой эффект)"
    }}
  ],
  "immediate_actions": ["действие1", "действие2"],
  "long_term_strategy": "string (долгосрочная стратегия)"
}}"""


def get_letter_generation_prompt(bki_type: str, errors: list, client_data: dict) -> str:
    """Промпт для генерации письма в БКИ"""
    return f"""Сгенерируй официальное письмо в {bki_type} для оспаривания ошибок в кредитном отчёте.

ДАННЫЕ КЛИЕНТА:
- ФИО: {client_data.get('full_name', '')}
- Дата рождения: {client_data.get('birth_date', '')}
- Паспорт: {client_data.get('passport', '')}

ОБНАРУЖЕННЫЕ ОШИБКИ:
{errors}

ТРЕБОВАНИЯ К ПИСЬМУ:
1. Официальный деловой стиль
2. Указать конкретные ошибки с доказательствами
3. Требовать исправления в установленные сроки
4. Ссылаться на ФЗ-218 "О кредитных историях"
5. Указать контактные данные для связи

Верни ТОЛЬКО текст письма без дополнительных комментариев."""



